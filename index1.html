<script>
  // ====== GOOGLE DRIVE SETTINGS ======
  const CLIENT_ID = "220214661440-iqhbhncgbg34b6imeeha44pemj3pbf79.apps.googleusercontent.com";
  const API_KEY = "AIzaSyBoHLyl_H6q4XRo6si-vdy1CnfNHOsVLD8";

  // Folder IDs
  const PHOTO_FOLDER_ID = "1Ep4A7YqTfClYusea7NamuR1FKO6aW7HK";
  const DOC_FOLDER_ID   = "1feFodHcNSZa38XUx9lbt08HM2rjq2HsH";

  const DISCOVERY_DOC = "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest";

  // For uploading: drive.file lets your app create/manage its own files.
  // Note: listing may require user access unless folders/files are shared publicly.
  const SCOPES = "https://www.googleapis.com/auth/drive.file";

  let tokenClient;
  let gapiInited = false;
  let gisInited = false;

  // ====== DOM ELEMENTS ======
  const addPhotosButton = document.getElementById("driveAddPhotos");
  const signoutButton = document.getElementById("driveSignout");
  const photoInput = document.getElementById("photoInput");
  const photoHint = document.getElementById("photoHint");

  const photoGrid = document.getElementById("photoGrid");
  const photoStatus = document.getElementById("photoStatus");

  const docGrid = document.getElementById("docGrid");
  const docStatus = document.getElementById("docStatus");

  // Disable button until both libraries are ready (if button exists)
  if (addPhotosButton) addPhotosButton.disabled = true;

  function maybeEnableAddButton() {
    if (addPhotosButton && gapiInited && gisInited) {
      addPhotosButton.disabled = false;
    }
  }

  // ====== LOAD + INIT GOOGLE APIs ======
  // Called when gapi script loads
  window.gapiLoaded = function gapiLoaded() {
    gapi.load("client", async () => {
      await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: [DISCOVERY_DOC],
      });
      gapiInited = true;
      maybeEnableAddButton();

      // Try to load galleries immediately (works if folders/files are public)
      refreshGalleries();
    });
  };

  // Called when Google Identity script loads
  window.gisLoaded = function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: "", // set dynamically when requesting token
    });
    gisInited = true;
    maybeEnableAddButton();
  };

  // ====== GALLERY REFRESH ======
  async function refreshGalleries() {
    // Best effort: will work fully after login, or for public/shared files without auth
    await listDriveImages(PHOTO_FOLDER_ID);
    await listDriveDocs(DOC_FOLDER_ID);
  }

  async function listDriveImages(folderId) {
    if (!photoGrid) return;

    photoGrid.innerHTML = "";
    if (photoStatus) photoStatus.textContent = "Loading photos…";

    try {
      const res = await gapi.client.drive.files.list({
        q: `'${folderId}' in parents and trashed=false and mimeType contains 'image/'`,
        fields: "files(id,name,mimeType,thumbnailLink,webViewLink)",
        pageSize: 100,
        orderBy: "createdTime desc",
      });

      const files = res.result.files || [];
      if (!files.length) {
        if (photoStatus) photoStatus.textContent = "No photos found.";
        return;
      }

      for (const f of files) {
        const card = document.createElement("div");
        card.className = "media-card";

        const img = document.createElement("img");
        // thumbnailLink is convenient when authorized; fallback works for public files.
        img.src = f.thumbnailLink
          ? f.thumbnailLink.replace("=s220", "=s800")
          : `https://drive.google.com/uc?export=view&id=${f.id}`;
        img.alt = f.name;

        img.style.cursor = "pointer";
        img.addEventListener("click", () => {
          const url = f.webViewLink || `https://drive.google.com/file/d/${f.id}/view`;
          window.open(url, "_blank", "noopener");
        });

        const caption = document.createElement("span");
        caption.textContent = f.name;

        card.appendChild(img);
        card.appendChild(caption);
        photoGrid.appendChild(card);
      }

      if (photoStatus) photoStatus.textContent = "";
    } catch (err) {
      console.error("Error listing Drive images:", err);
      if (photoStatus) {
        photoStatus.textContent =
          "Could not load photos. If you are not logged in, the folder/files may not be public.";
      }
    }
  }

  async function listDriveDocs(folderId) {
    if (!docGrid) return;

    docGrid.innerHTML = "";
    if (docStatus) docStatus.textContent = "Loading documents…";

    try {
      const res = await gapi.client.drive.files.list({
        q: `'${folderId}' in parents and trashed=false`,
        fields: "files(id,name,mimeType,webViewLink)",
        pageSize: 200,
        orderBy: "createdTime desc",
      });

      const files = (res.result.files || []).filter((f) => {
        return f.mimeType !== "application/vnd.google-apps.folder";
      });

      if (!files.length) {
        if (docStatus) docStatus.textContent = "No documents found.";
        return;
      }

      for (const f of files) {
        const card = document.createElement("div");
        card.className = "media-card";

        const title = document.createElement("span");
        title.textContent = f.name;

        const link = document.createElement("a");
        link.href = f.webViewLink || `https://drive.google.com/file/d/${f.id}/view`;
        link.target = "_blank";
        link.rel = "noopener";
        link.textContent = "Open";

        card.appendChild(title);
        card.appendChild(link);
        docGrid.appendChild(card);
      }

      if (docStatus) docStatus.textContent = "";
    } catch (err) {
      console.error("Error listing Drive docs:", err);
      if (docStatus) {
        docStatus.textContent =
          "Could not load documents. If you are not logged in, the folder/files may not be public.";
      }
    }
  }

  // ====== LOGIN + UPLOAD FLOW ======
  function hasAccessToken() {
    try {
      return !!gapi.client.getToken();
    } catch {
      return false;
    }
  }

  function setSignedInUI(isSignedIn) {
    if (signoutButton) signoutButton.style.display = isSignedIn ? "inline-block" : "none";
    if (photoHint) {
      photoHint.textContent = isSignedIn
        ? "Choose photos to upload. They will appear in the gallery."
        : "To add photos, click the button below. You’ll be asked to sign in with Google once.";
    }
  }

  // Main button: login if needed, then open file picker
  if (addPhotosButton) {
    addPhotosButton.addEventListener("click", () => {
      const continueFlow = () => {
        setSignedInUI(true);
        if (photoInput) photoInput.click();
      };

      if (!hasAccessToken()) {
        tokenClient.callback = async (resp) => {
          if (resp.error) {
            console.error(resp);
            alert("Google login failed. Please try again.");
            return;
          }
          // Now authorized — refresh galleries (private folders will load)
          await refreshGalleries();
          continueFlow();
        };
        tokenClient.requestAccessToken({prompt: "consent"});
      } else {
        continueFlow();
      }
    });
  }

  // When files are chosen, upload them automatically
  if (photoInput) {
    photoInput.addEventListener("change", async () => {
      const files = Array.from(photoInput.files || []);
      if (!files.length) return;

      if (addPhotosButton) {
        addPhotosButton.disabled = true;
        addPhotosButton.textContent = "Uploading...";
      }

      try {
        for (const file of files) {
          await uploadFileToDrive(file, PHOTO_FOLDER_ID);
        }
        await refreshGalleries();
        alert("Upload complete! New photos should appear in the gallery.");
      } catch (err) {
        console.error("Upload error:", err);
        alert("There was a problem uploading one or more photos.");
      } finally {
        photoInput.value = "";
        if (addPhotosButton) {
          addPhotosButton.disabled = false;
          addPhotosButton.textContent = "Add photos (Google login required)";
        }
      }
    });
  }

  // Optional: sign out button
  if (signoutButton) {
    signoutButton.addEventListener("click", () => {
      const token = gapi.client.getToken();
      if (token) {
        google.accounts.oauth2.revoke(token.access_token);
        gapi.client.setToken("");
      }
      setSignedInUI(false);
      // After signout, attempt to refresh (will show public-only)
      refreshGalleries();
    });
  }

  // ====== UPLOAD IMPLEMENTATION ======
  async function uploadFileToDrive(file, folderId) {
    const boundary = "-------314159265358979323846";
    const delimiter = "\r\n--" + boundary + "\r\n";
    const closeDelim = "\r\n--" + boundary + "--";

    const metadata = {
      name: file.name,
      parents: [folderId],
    };

    const reader = new FileReader();

    return new Promise((resolve, reject) => {
      reader.onload = async (e) => {
        try {
          const contentType = file.type || "application/octet-stream";
          const bytes = new Uint8Array(e.target.result);

          // Convert bytes to base64
          let binary = "";
          for (let i = 0; i < bytes.length; i++) {
            binary += String.fromCharCode(bytes[i]);
          }
          const base64Data = btoa(binary);

          const multipartRequestBody =
            delimiter +
            "Content-Type: application/json\r\n\r\n" +
            JSON.stringify(metadata) +
            delimiter +
            "Content-Type: " + contentType + "\r\n" +
            "Content-Transfer-Encoding: base64\r\n\r\n" +
            base64Data +
            closeDelim;

          const response = await gapi.client.request({
            path: "/upload/drive/v3/files",
            method: "POST",
            params: {uploadType: "multipart"},
            headers: {"Content-Type": "multipart/related; boundary=" + boundary},
            body: multipartRequestBody,
          });

          resolve(response.result);
        } catch (err) {
          reject(err);
        }
      };

      reader.onerror = reject;
      reader.readAsArrayBuffer(file);
    });
  }
</script>

<!-- Google Identity + GAPI scripts -->
<script src="https://accounts.google.com/gsi/client" async defer onload="gisLoaded()"></script>
<script src="https://apis.google.com/js/api.js" async defer onload="gapiLoaded()"></script>
